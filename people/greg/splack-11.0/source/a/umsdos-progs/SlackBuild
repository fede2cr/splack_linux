#!/bin/sh
# Set initial variables:
CWD=`pwd`
if [ "$TMP" = "" ]; then
  TMP=/tmp
fi
PKG=$TMP/package-umsdos-progs

VERSION=1.13
ARCH=i386
BUILD=1

if [ ! -d $TMP ]; then
  mkdir -p $TMP # location to build the source
fi
if [ ! -d $PKG ]; then
  mkdir -p $PKG # place for the package to be built
fi

# Explode the package framework:
cd $PKG
explodepkg $CWD/_umsdos-progs.tar.gz

echo "+===================+"
echo "| umsdos-progs-$VERSION |"
echo "+===================+"
#echo "************* Recommend not using shared libg++"
cd $TMP
tar xzvf $CWD/umsdos_progs-$VERSION.tar.gz
cd umsdos_progs
mkdir -p $PKG/usr/doc/umsdos-progs-$VERSION
cp -a README $PKG/usr/doc/umsdos-progs-$VERSION
cp -a util/README $PKG/usr/doc/umsdos-progs-$VERSION/README.utils
cp -a util/TODO $PKG/usr/doc/umsdos-progs-$VERSION/TODO
chown root:root $PKG/usr/doc/umsdos-progs-$VERSION/*
chmod 644 $PKG/usr/doc/umsdos-progs-$VERSION/*
make
## Relink without libstdc++, which seems unnecessary: (this is now the default)
#cc -o umssync main.o umssync.o umssetup.o udosctl.o \
#   umsdosio.o mangle.o numconst.o printk.o
cd util
strip umssync testver udump
cat umssync > $PKG/sbin/umssync
cat umssync.8 | gzip -9c > $PKG/usr/man/man8/umssync.8.gz
cat testver > $PKG/usr/sbin/testver
cat udump > $PKG/usr/sbin/udump
mkdir -p $PKG/install
cat $CWD/slack-desc > $PKG/install/slack-desc

# Build the package:
cd $PKG
echo "n" | makepkg $TMP/umsdos-progs-$VERSION-$ARCH-$BUILD.tgz

# Clean up the extra stuff:
if [ "$1" = "--cleanup" ]; then
  rm -rf $TMP/umsdos_progs
  rm -rf $PKG
fi
